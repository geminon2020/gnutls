stages:
  - stage1-testing

# we utilize the images generated by the build-images project, to
# speed up CI runs. We also use ccache and store config.cache
# to speed up compilation. We include a version number in cache
# name to allow expiration of old caches.

cache:
  key: "$CI_JOB_NAME-ver14"
  paths:
    - cache/

before_script:
  # CCache Config
  - mkdir -p cache
  - export CCACHE_BASEDIR=${PWD}
  - export CCACHE_DIR=${PWD}/cache
  - export CC="ccache gcc"

# With just one virtual core, parallel builds only make sense when
# I/O wait is involved. If too many parallel builds are used, the overall
# time even increases (e.g. due to more cache misses).
# $BUILDJOBS seems to be best with $(nproc)+1, while $CHECKJOBS can be much
# higher because several tests have a large I/O waiting time.
# The numbers are hard-coded since FreeBSD doesn't know the nproc command.
  - export BUILDJOBS=2
  - export CHECKJOBS=16

after_script:
  # somehow after_script looses environment
  - export CCACHE_BASEDIR=${PWD}
  - export CCACHE_DIR=${PWD}/cache
  - ccache -s

variables:
  BUILD_IMAGES_PROJECT: gnutls/build-images
  DEBIAN_BUILD: buildenv-debian
  DEBIAN_CROSS_BUILD: buildenv-debian-cross
  DEBIAN_X86_CROSS_BUILD: buildenv-debian-x86-cross
  FEDORA28_BUILD: buildenv-f28
  FEDORA_BUILD: buildenv-fedora31
  MINGW_BUILD: buildenv-mingw
  ALPINE_BASE_BUILD: buildenv-alpine-base
  CPPCHECK_OPTIONS: "--enable=warning --enable=style --enable=performance --enable=portability --std=c99 --suppressions-list=devel/cppcheck.suppressions -i lib/nettle/curve448 --template='{id}:{file}:{line},{severity},{message}'"
  GET_SOURCES_ATTEMPTS: "3"

##################################################
# Stage 1, documentation, and advanced checks
##################################################

clang.Fedora:
  stage: stage1-testing
  image: $CI_REGISTRY/$BUILD_IMAGES_PROJECT:$FEDORA_BUILD
  script:
    - export CC=clang
    - export CXX=clang++
    - export CFLAGS="-std=c99 -O2 -g"
    - git clone https://git.lysator.liu.se/nettle/nettle.git
    - cd nettle
    - bash .bootstrap
    - CC=clang ./configure --enable-mini-gmp --enable-shared --disable-documentation
    - make -j$(nproc)
    - make check -j$(nproc)
    - make install
    - cd ..

    - SKIP_PO=1 ./bootstrap
    - ./configure --with-nettle-mini --enable-shared --with-included-libtasn1 --with-included-unistring --without-p11-kit --disable-doc --disable-libdane
    - make -j$BUILDJOBS
    - make -j$CHECKJOBS check
  
  tags:
    - shared
    - linux
  except:
    - tags
  retry: 1
